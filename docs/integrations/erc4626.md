# ERC4626 Integration

## Quick Reference
- Fuse contracts: `Erc4626SupplyFuse.sol`, `Erc4626BalanceFuse.sol`
- Market IDs: ERC4626_0001 to ERC4626_0020 (100_001 to 100_020)
- External contracts: Any ERC4626-compliant vault

## Fuse Interface

### Erc4626SupplyFuse
```
enter(vault, vaultAssetAmount, minSharesOut)
  -> returns finalVaultAssetAmount
  - Deposits underlying asset into ERC4626 vault
  - vault address must be granted substrate for the market
  - Caps deposit to min(requested, available balance of underlying)
  - Calls vault.deposit(amount, address(this))
  - Reverts with Erc4626SupplyFuseInsufficientShares if shares < minSharesOut

exit(vault, vaultAssetAmount, maxSharesBurned)
  -> returns shares
  - Withdraws underlying asset from ERC4626 vault
  - Caps withdrawal to min(requested, vault.maxWithdraw(address(this)))
  - Calls vault.withdraw(amount, address(this), address(this))
  - Reverts with Erc4626SupplyFuseExcessiveSharesBurned if shares > maxSharesBurned (when maxSharesBurned > 0)

instantWithdraw(params[amount, vaultAddress])
  - Instant withdrawal for PlasmaVault redemptions
  - Wrapped in try/catch: on failure emits ExitFailed event and continues
  - No maxSharesBurned check in instant withdraw mode
```

## Balance Tracking
`Erc4626BalanceFuse.balanceOf()`:
- Iterates all vault substrates for the market
- For each vault: `vaultAssets = vault.convertToAssets(vault.balanceOf(plasmaVault))`
- Gets underlying asset price from PriceOracleMiddleware
- Converts to USD: `IporMath.convertToWad(vaultAssets * price, decimals + priceDecimals)`
- Returns sum in WAD (18 decimals)

## Key Invariants
- Substrates are ERC4626 vault addresses (not underlying token addresses)
- Price feed must be configured for the vault's underlying asset (not the vault itself)
- 20 market ID slots available (100_001 to 100_020) for different vault deployments
- minSharesOut on enter and maxSharesBurned on exit provide slippage protection
- instantWithdraw uses try/catch to be fault-tolerant during batch redemptions

## Risks & Edge Cases
- Vault share price manipulation: convertToAssets() relies on vault's internal accounting
- maxWithdraw() may return less than expected if vault has withdrawal limits or queues
- instantWithdraw silently fails (emits event) -- caller should check final balance
- Some ERC4626 vaults may have deposit/withdrawal fees affecting share ratios
- Vault with 0 totalSupply or non-standard decimals may cause unexpected behavior

## Related Files
- Source: `contracts/fuses/erc4626/`
- Interfaces: OpenZeppelin `IERC4626`, `IERC20Metadata`
